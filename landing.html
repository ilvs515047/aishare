<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å‚ç›´æ ¡æ­£ä¸»è¼ªæ¨¡æ“¬å™¨ V2</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #333;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        #canvas-container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        /* UI å±¤ */
        #ui-layer {
            position: absolute;
            top: 20px;
            left: 20px;
            pointer-events: none;
            z-index: 10;
        }

        .hud-panel {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            color: #0f0; /* HUD ç¶ è‰² */
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.5);
            width: 200px;
        }

        .hud-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .hud-label { opacity: 0.8; font-size: 0.9rem; }
        .hud-value { font-weight: bold; }

        .bar-container {
            width: 100%;
            height: 6px;
            background: #333;
            margin-top: 5px;
            position: relative;
            border-radius: 3px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: #0f0;
            width: 0%;
            transition: width 0.05s linear;
        }

        /* è­¦å‘Šæ–‡å­— */
        #alert-box {
            position: absolute;
            top: 160px;
            left: 20px;
            background: rgba(200, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            font-weight: bold;
            font-size: 1.2rem;
            border-radius: 4px;
            display: none;
            animation: flash 0.2s infinite alternate;
        }

        @keyframes flash {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }

        /* å•Ÿå‹•/æ ¡æ­£æŒ‰éˆ•å±¤ */
        #overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            text-align: center;
        }

        .instruction-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        #start-btn {
            padding: 15px 40px;
            font-size: 1.2rem;
            background: #0f0;
            color: #000;
            border: none;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 255, 0, 0.6);
            margin-top: 30px;
            transition: transform 0.2s;
        }

        #start-btn:active {
            transform: scale(0.95);
        }

        /* é‡è¨­æŒ‰éˆ• */
        #recalibrate-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid white;
            padding: 10px 20px;
            border-radius: 30px;
            cursor: pointer;
            pointer-events: auto;
            font-size: 1rem;
            display: none; /* é–‹å§‹å¾Œé¡¯ç¤º */
            backdrop-filter: blur(4px);
        }

        /* è¨­å®šé¢æ¿æŒ‰éˆ• */
        #settings-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 1.2rem;
            z-index: 50;
        }

        /* è¨­å®šé¢æ¿ */
        #settings-panel {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            border: 1px solid #555;
            padding: 20px;
            border-radius: 10px;
            color: white;
            width: 220px;
            display: none;
            z-index: 50;
            backdrop-filter: blur(10px);
        }

        .setting-row {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        input[type="range"] {
            width: 100px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: #0f0; }
        input:checked + .slider:before { transform: translateX(20px); }

        #debug-val {
            font-family: monospace;
            color: #aaa;
            font-size: 0.8rem;
            text-align: right;
            margin-top: 10px;
        }
        
        /* æ¸¬è©¦ç”¨æ»‘æ¡¿ (ç„¡æ„Ÿæ‡‰å™¨æ™‚é¡¯ç¤º) */
        #manual-slider-container {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            height: 200px;
            display: none;
            flex-direction: column;
            align-items: center;
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;
            z-index: 40;
        }
    </style>
</head>
<body>

<div id="canvas-container">
    <canvas id="simCanvas"></canvas>
    
    <!-- HUD -->
    <div id="ui-layer">
        <div class="hud-panel">
            <div class="hud-row">
                <span class="hud-label">STRUT (å£“ç¸®)</span>
                <span class="hud-value" id="val-strut">100%</span>
            </div>
            <div class="bar-container">
                <div class="bar-fill" id="bar-strut"></div>
            </div>
            
            <div class="hud-row" style="margin-top:10px;">
                <span class="hud-label">G-FORCE</span>
                <span class="hud-value" id="val-g">1.0</span>
            </div>
            <div class="bar-container">
                <div class="bar-fill" id="bar-g" style="background: linear-gradient(90deg, lime, yellow, red);"></div>
            </div>
            
            <div class="hud-row" style="margin-top:10px;">
                <span class="hud-label">HEIGHT</span>
                <span class="hud-value" id="val-height">0</span>
            </div>
        </div>
        <div id="alert-box">HARD LANDING!</div>
    </div>

    <!-- è¨­å®šæŒ‰éˆ•èˆ‡é¢æ¿ -->
    <div id="settings-toggle">âš™ï¸</div>
    <div id="settings-panel">
        <h3 style="margin-top:0; border-bottom:1px solid #555; padding-bottom:5px;">æ§åˆ¶è¨­å®š</h3>
        
        <div class="setting-row">
            <span>åè½‰æ„Ÿæ‡‰æ–¹å‘</span>
            <label class="switch">
                <input type="checkbox" id="invert-check">
                <span class="slider"></span>
            </label>
        </div>

        <div class="setting-row">
            <span>éˆæ•åº¦</span>
            <input type="range" id="sens-slider" min="1" max="15" value="6">
        </div>
        
        <div id="debug-val">Tilt Delta: 0</div>
        <p style="font-size:0.75rem; color:#888; margin-bottom:0;">
            *è‹¥æ“ä½œæ–¹å‘ç›¸åè«‹é–‹å•Ÿã€Œåè½‰ã€ã€‚
        </p>
    </div>

    <!-- å•Ÿå‹•èˆ‡æ ¡æ­£ç•«é¢ -->
    <div id="overlay">
        <div class="instruction-icon">ğŸ“±</div>
        <h2 style="margin:0;">è«‹å°‡æ‰‹æ©Ÿå‚ç›´ç«‹æ–¼æ¡Œé¢</h2>
        <p style="color:#ccc; max-width: 80%; line-height: 1.6;">
            1. ä¿æŒæ‰‹æ©Ÿå‚ç›´ä¸å‹• (è¢å¹•é¢å‘è‡ªå·±)<br>
            2. é»æ“ŠæŒ‰éˆ•è¨­å®šåŸºæº–é»<br>
            3. æ‰‹æ©Ÿå¾€<strong>å¾Œä»°</strong>(æ‹‰èµ·) = é£›æ©Ÿä¸Šå‡<br>
            4. æ‰‹æ©Ÿå¾€<strong>å‰å‚¾</strong>(å£“ä½) = é£›æ©Ÿä¸‹é™
        </p>
        <button id="start-btn">æ ¡æ­£åŸºæº–ä¸¦é–‹å§‹</button>
        <p id="sensor-status" style="font-size:0.8rem; margin-top:20px; color:#666;">ç­‰å¾…æ„Ÿæ‡‰å™¨...</p>
    </div>

    <button id="recalibrate-btn">é‡æ–°æ ¡æ­£æ­¸é›¶</button>

    <!-- å‚™ç”¨æ»‘æ¡¿ -->
    <div id="manual-slider-container">
        <span style="color:white; font-size:0.8rem; margin-bottom:5px;">é«˜åº¦</span>
        <input type="range" id="manual-slider" min="-50" max="50" value="0" style="writing-mode: bt-lr; -webkit-appearance: slider-vertical; height: 100%;">
    </div>
</div>

<script>
    // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„èˆŠå‹•ç•«è¿´åœˆ (é˜²æ­¢é‡è¤‡åŸ·è¡Œå°è‡´åŠ é€Ÿ)
    if (window.simAnimationId) {
        cancelAnimationFrame(window.simAnimationId);
    }

    // --- æ ¸å¿ƒè®Šæ•¸ (ä½¿ç”¨ var ä»¥é¿å…é‡æ–°åŸ·è¡Œæ™‚å ±éŒ¯) ---
    var canvas = document.getElementById('simCanvas');
    var ctx = canvas.getContext('2d');
    
    // UI å…ƒç´ 
    var overlay = document.getElementById('overlay');
    var startBtn = document.getElementById('start-btn');
    var recalibrateBtn = document.getElementById('recalibrate-btn');
    var sensorStatus = document.getElementById('sensor-status');
    var settingsToggle = document.getElementById('settings-toggle');
    var settingsPanel = document.getElementById('settings-panel');
    var invertCheck = document.getElementById('invert-check');
    var sensSlider = document.getElementById('sens-slider');
    var debugVal = document.getElementById('debug-val');
    
    // HUD
    var uiStrut = document.getElementById('val-strut');
    var barStrut = document.getElementById('bar-strut');
    var uiG = document.getElementById('val-g');
    var barG = document.getElementById('bar-g');
    var uiHeight = document.getElementById('val-height');
    var uiAlert = document.getElementById('alert-box');
    
    // å‚™ç”¨æ§åˆ¶
    var manualContainer = document.getElementById('manual-slider-container');
    var manualSlider = document.getElementById('manual-slider');

    // ç³»çµ±ç‹€æ…‹
    var width, height;
    var groundY = 0; 
    var isRunning = false;
    var useSensor = false;

    // è¨­å®šåƒæ•¸
    var SETTING_INVERT = false;
    var SETTING_SENSITIVITY = 6;

    // æ„Ÿæ‡‰å™¨æ•¸æ“š
    var calibratedBeta = 0; 
    var currentBeta = null;

    // --- ç‰©ç†æ¨¡å‹ ---
    var P = {
        // ä½ç½®
        aircraftY: 0,
        targetAircraftY: 0,
        
        // å¹¾ä½• (å–®ä½: px)
        fullLen: 220,      // å®Œå…¨ä¼¸å±•é•·åº¦
        compressedLen: 120,// å®Œå…¨å£“ç¸®é•·åº¦
        radius: 45,        // è¼ªèƒåŠå¾‘
        
        // å‹•æ…‹
        currentLen: 220,   
        velocity: 0,       
        wheelRot: 0,      
        
        // ç‰©ç†å¸¸æ•¸
        springK: 0.25,      // å½ˆç°§ç¡¬åº¦ (è¶Šå°è¶Šè»Ÿ)
        damping: 0.75,      // é˜»å°¼ (å¸æ”¶èƒ½é‡)
        
        gForce: 1.0,
        isOnGround: false,
        
        groundSpeed: 25,
        smoke: []
    };

    // --- åˆå§‹åŒ–èˆ‡äº‹ä»¶ ---
    function resize() {
        width = window.innerWidth;
        height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;
        groundY = height / 2 + 100; // åœ°é¢ä½ç½®åä¸‹ä¸€é»ï¼Œç•™ç©ºé–“çµ¦å¤©ç©º
        
        if (!isRunning) {
            // åˆå§‹åœåœ¨åœ°é¢
            P.targetAircraftY = groundY - (P.fullLen + P.radius);
            P.aircraftY = P.targetAircraftY;
        }
    }
    window.addEventListener('resize', resize);
    resize();

    // è¨­å®šé¢æ¿é–‹é—œ
    // ç§»é™¤èˆŠäº‹ä»¶é¿å…ç–ŠåŠ  (é¸ç”¨ï¼Œé€™è£¡ç›´æ¥æ·»åŠ )
    settingsToggle.onclick = function() {
        if(settingsPanel.style.display === 'block') {
            settingsPanel.style.display = 'none';
        } else {
            settingsPanel.style.display = 'block';
        }
    };

    invertCheck.onchange = function(e) {
        SETTING_INVERT = e.target.checked;
    };

    sensSlider.oninput = function(e) {
        SETTING_SENSITIVITY = parseInt(e.target.value);
    };

    // --- æ„Ÿæ‡‰å™¨è™•ç† ---
    if (window.DeviceOrientationEvent) {
        window.addEventListener('deviceorientation', function(e) {
            if(e.beta !== null) {
                currentBeta = e.beta;
                sensorStatus.innerText = `æ„Ÿæ‡‰å™¨é‹ä½œä¸­: ${e.beta.toFixed(1)}Â°`;
                if (isRunning && useSensor) {
                    updateTargetFromSensor(e.beta);
                }
            }
        });
    } else {
        sensorStatus.innerText = "æœªåµæ¸¬åˆ°æ„Ÿæ‡‰å™¨";
    }

    startBtn.onclick = function() {
        // iOS éœ€è¦æ¬Šé™è«‹æ±‚
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        startSimulation(true);
                    } else {
                        alert("éœ€è¦å‹•ä½œæ¬Šé™æ‰èƒ½ä½¿ç”¨å‚¾æ–œæ§åˆ¶");
                        startSimulation(false);
                    }
                })
                .catch(console.error);
        } else {
            // Android æˆ– PC
            startSimulation(currentBeta !== null);
        }
    };

    recalibrateBtn.onclick = calibrate;

    function startSimulation(hasSensor) {
        useSensor = hasSensor;
        calibrate();
        
        overlay.style.display = 'none';
        recalibrateBtn.style.display = 'block';
        
        if(!hasSensor) {
            manualContainer.style.display = 'flex';
            manualSlider.oninput = function(e) {
                // æ»‘æ¡¿æ¨¡å¼
                var val = parseInt(e.target.value); // -50(ä¸Š) ~ 50(ä¸‹)
                var baseLevel = groundY - (P.fullLen + P.radius);
                P.targetAircraftY = baseLevel + (val * 5);
            };
            showToast("ç„¡æ„Ÿæ‡‰å™¨ï¼Œè«‹ä½¿ç”¨å³å´æ»‘æ¡¿");
        }
        
        isRunning = true;
        loop();
    }

    function calibrate() {
        if (currentBeta !== null) {
            calibratedBeta = currentBeta;
            // æ ¡æ­£æ™‚ï¼Œå°‡é£›æ©Ÿé‡ç½®åˆ°ã€Œå‰›å¥½è§¸åœ°ã€ä½ç½®
            var baseLevel = groundY - (P.fullLen + P.radius);
            P.targetAircraftY = baseLevel;
            P.velocity = 0;
            showToast("å·²æ ¡æ­£æ­¸é›¶");
        } else if (!useSensor) {
             manualSlider.value = 0;
             var baseLevel = groundY - (P.fullLen + P.radius);
             P.targetAircraftY = baseLevel;
        }
    }

    function updateTargetFromSensor(beta) {
        // è¨ˆç®—è§’åº¦åå·®
        var diff = beta - calibratedBeta;
        
        // é‚è¼¯è½‰æ›
        // é è¨­ï¼šæ‰‹æ©Ÿå‚ç›´(0) -> å¾Œä»°(betaå¢åŠ , +) -> é£›æ©Ÿä¸Šå‡ (Y æ¸›å°‘)
        //       æ‰‹æ©Ÿå‚ç›´(0) -> å‰å‚¾(betaæ¸›å°‘, -) -> é£›æ©Ÿä¸‹é™ (Y å¢åŠ )
        
        if (SETTING_INVERT) {
            diff = -diff;
        }
        
        // é¡¯ç¤ºé™¤éŒ¯æ•¸å€¼
        debugVal.innerText = `Delta: ${diff.toFixed(1)}Â°`;

        var baseLevel = groundY - (P.fullLen + P.radius);
        
        // è¨ˆç®—ç›®æ¨™é«˜åº¦
        // é€™è£¡çš„ diff æ­£å€¼ä»£è¡¨å¾Œä»°(å¸Œæœ›ä¸Šå‡)ï¼Œæ‰€ä»¥ç”¨æ¸›æ³•
        P.targetAircraftY = baseLevel - (diff * SETTING_SENSITIVITY);
    }

    // --- ç‰©ç†æ ¸å¿ƒ ---
    function updatePhysics() {
        // 1. æ©Ÿèº«å¹³æ»‘è·Ÿéš¨ç›®æ¨™
        var dy = P.targetAircraftY - P.aircraftY;
        P.velocity += dy * 0.08; 
        P.velocity *= 0.85; // é˜»å°¼
        P.aircraftY += P.velocity;

        // 2. è¨ˆç®—è¼ªå­èˆ‡åœ°é¢é—œä¿‚
        // å‡è¨­é¿éœ‡å®Œå…¨ä¼¸å±•æ™‚çš„è¼ªåº•ä½ç½®
        var extendedWheelBottom = P.aircraftY + P.fullLen + P.radius;
        
        var force = 0; // åœ°é¢åä½œç”¨åŠ›
        
        if (extendedWheelBottom > groundY) {
            // --- è§¸åœ°ç‹€æ…‹ ---
            if (!P.isOnGround) {
                P.isOnGround = true;
                // åªæœ‰ä¸‹é™é€Ÿåº¦å¤ å¿«æ‰ç”¢ç”Ÿç…™éœ§
                if(P.velocity > 2) spawnSmoke(10);
            }
            
            // å¼·åˆ¶è¨ˆç®—é¿éœ‡å£“ç¸®å¾Œçš„é•·åº¦
            // è¼ªè»¸å¿…é ˆåœ¨ groundY - radius çš„ä½ç½® (å‰›é«”è¼ªèƒ)
            var wheelAxleY = groundY - P.radius;
            var newStrutLen = wheelAxleY - P.aircraftY;
            
            // é™åˆ¶ï¼šä¸èƒ½å£“ç©¿é¿éœ‡å™¨ (Bottom Out)
            if (newStrutLen < P.compressedLen) {
                // æ©Ÿèº«æ’æ“Šåœ°é¢åä½œç”¨åŠ›
                var penetration = P.compressedLen - newStrutLen;
                force += penetration * 20; 
                newStrutLen = P.compressedLen;
            }
            
            P.currentLen = newStrutLen;
            
            // è¨ˆç®—å½ˆç°§å£“ç¸®åŠ› F = kx
            // å£“ç¸®é‡
            var compression = P.fullLen - P.currentLen;
            force += compression * P.springK;
            
            // è¼ªå­è½‰é€ŸåŠ é€Ÿåˆ°åœ°é¢é€Ÿåº¦
            P.wheelRot += (P.groundSpeed - P.wheelRot) * 0.1;
            
        } else {
            // --- ç©ºä¸­ç‹€æ…‹ ---
            P.isOnGround = false;
            
            // é¿éœ‡ä¼¸å±• (é˜»å°¼å›å½ˆ)
            if (P.currentLen < P.fullLen) {
                P.currentLen += (P.fullLen - P.currentLen) * 0.15;
            } else {
                P.currentLen = P.fullLen;
            }
            
            // è¼ªå­è‡ªç„¶æ¸›é€Ÿ
            P.wheelRot *= 0.98;
        }
        
        // 3. è¨ˆç®— GåŠ› (1G + åŠ é€Ÿåº¦è®ŠåŒ–)
        var dynamicG = force * 0.1; 
        // ç°¡å–®æ¨¡æ“¬ï¼šéœæ­¢æ™‚ 1G
        var totalG = 1.0 + dynamicG;
        // å¹³æ»‘é¡¯ç¤º
        P.gForce = P.gForce * 0.8 + totalG * 0.2;
        
        // 4. æ›´æ–°UIæ•¸å€¼
        updateUI();
    }

    function updateUI() {
        // Strut Bar
        var compressPct = 100 - ((P.currentLen - P.compressedLen) / (P.fullLen - P.compressedLen) * 100);
        compressPct = Math.max(0, Math.min(100, compressPct));
        uiStrut.innerText = compressPct.toFixed(0) + "%";
        barStrut.style.width = compressPct + "%";
        
        // é¡è‰²é‚è¼¯
        if(compressPct > 90) barStrut.style.backgroundColor = "#ff0000"; // ç´…
        else if(compressPct > 70) barStrut.style.backgroundColor = "#ffff00"; // é»ƒ
        else barStrut.style.backgroundColor = "#00ff00"; // ç¶ 

        // G Bar
        uiG.innerText = P.gForce.toFixed(2);
        var gPct = (P.gForce / 4) * 100; // å‡è¨­4Gæ»¿æ ¼
        barG.style.width = Math.min(100, gPct) + "%";
        
        // Height (ç›¸å°åœ°é¢)
        var alt = Math.max(0, groundY - (P.aircraftY + P.fullLen + P.radius));
        uiHeight.innerText = alt.toFixed(0);
        
        // Warning
        if (P.gForce > 2.5) {
            uiAlert.style.display = 'block';
        } else {
            uiAlert.style.display = 'none';
        }
    }

    // --- ç¹ªåœ–ç³»çµ± ---
    function draw() {
        ctx.clearRect(0, 0, width, height);
        
        // 1. èƒŒæ™¯
        drawBackground();
        
        // 2. èµ·è½æ¶
        drawGear(width/2, P.aircraftY, P.currentLen);
        
        // 3. ç…™éœ§
        drawSmoke();
    }

    function drawBackground() {
        // å¤©ç©º
        var skyGrad = ctx.createLinearGradient(0, 0, 0, groundY);
        skyGrad.addColorStop(0, '#001133');
        skyGrad.addColorStop(1, '#4facfe');
        ctx.fillStyle = skyGrad;
        ctx.fillRect(0, 0, width, groundY);
        
        // åœ°é¢
        var gGrad = ctx.createLinearGradient(0, groundY, 0, height);
        gGrad.addColorStop(0, '#333');
        gGrad.addColorStop(1, '#111');
        ctx.fillStyle = gGrad;
        ctx.fillRect(0, groundY, width, height - groundY);
        
        // åœ°å¹³ç·šç·šæ¢
        ctx.strokeStyle = "rgba(255,255,255,0.5)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(0, groundY);
        ctx.lineTo(width, groundY);
        ctx.stroke();

        // è·‘é“é€Ÿåº¦ç·š
        ctx.save();
        ctx.beginPath();
        ctx.rect(0, groundY, width, height-groundY);
        ctx.clip();
        
        // ç”¢ç”Ÿç§»å‹•æ„Ÿ
        var speedOffset = (Date.now() * (P.groundSpeed/20)) % 400; 
        
        ctx.fillStyle = "#555";
        for (var x = -speedOffset; x < width; x+=400) {
            // é€è¦–è®Šå½¢æ•ˆæœ
            ctx.fillRect(x + 150, groundY + 20, 100, 10);
            ctx.fillRect(x, groundY + 80, 200, 20);
        }
        ctx.restore();
    }

    function drawGear(x, y, len) {
        // é›¶ä»¶å°ºå¯¸
        var outW = 34; 
        var inW = 24;  
        var cylLen = 110; 
        
        ctx.save();
        ctx.translate(x, y);
        
        // A. æ©Ÿèº«çµæ§‹ (Mount)
        ctx.fillStyle = "#1a1a1a";
        ctx.beginPath();
        ctx.moveTo(-50, -40);
        ctx.lineTo(50, -40);
        ctx.lineTo(40, 10);
        ctx.lineTo(-40, 10);
        ctx.fill();
        // é‰šé‡˜ç´°ç¯€
        ctx.fillStyle = "#555";
        ctx.beginPath(); ctx.arc(-30, -15, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(30, -15, 3, 0, Math.PI*2); ctx.fill();

        // B. å¤–ç®¡ (Outer Cylinder)
        var gradOut = ctx.createLinearGradient(-outW/2, 0, outW/2, 0);
        gradOut.addColorStop(0, "#333");
        gradOut.addColorStop(0.3, "#777"); // é‡‘å±¬å…‰æ¾¤
        gradOut.addColorStop(1, "#222");
        ctx.fillStyle = gradOut;
        ctx.fillRect(-outW/2, 0, outW, cylLen);
        
        // å¤–ç®¡ä¸‹ç·£ç’°
        ctx.fillStyle = "#444";
        ctx.fillRect(-outW/2 - 2, cylLen-8, outW+4, 8);

        // C. å…§ç®¡ (Piston)
        // å…§ç®¡éœ²å‡ºé•·åº¦
        var pistonVisibleLen = len - cylLen;
        if(pistonVisibleLen < 0) pistonVisibleLen = 0;
        
        var gradIn = ctx.createLinearGradient(-inW/2, 0, inW/2, 0);
        gradIn.addColorStop(0, "#666");
        gradIn.addColorStop(0.4, "#fff"); // é«˜äº®éé‰»
        gradIn.addColorStop(0.6, "#ddd");
        gradIn.addColorStop(1, "#555");
        
        // ç¹ªè£½å…§ç®¡
        ctx.fillStyle = gradIn;
        ctx.fillRect(-inW/2, cylLen - 5, inW, pistonVisibleLen + 5);

        // D. æ‰­åŠ›è‡‚ (Torque Links/Scissors)
        // éš¨è‘—å£“ç¸®ç¨‹åº¦æ”¹è®Šè§’åº¦
        drawScissors(0, cylLen - 15, 0, len - 30);

        // E. è¼ªçµ„
        ctx.translate(0, len);
        
        // æ—‹è½‰è¼ªå­
        ctx.save();
        ctx.rotate(P.wheelRot);
        
        // è¼ªèƒ
        ctx.beginPath();
        ctx.arc(0, 0, P.radius, 0, Math.PI*2);
        var tireGrad = ctx.createRadialGradient(0,0, P.radius*0.5, 0,0, P.radius);
        tireGrad.addColorStop(0.5, "#222");
        tireGrad.addColorStop(1, "#000");
        ctx.fillStyle = tireGrad;
        ctx.fill();
        
        // è¼ªæ¡†
        ctx.beginPath();
        ctx.arc(0, 0, P.radius * 0.55, 0, Math.PI*2);
        ctx.fillStyle = "#ccc";
        ctx.fill();
        ctx.lineWidth = 3;
        ctx.strokeStyle = "#888";
        ctx.stroke();
        
        // è¼ªæ¡†èºçµ²ç´°ç¯€
        ctx.fillStyle = "#444";
        for(var i=0; i<8; i++) {
            var angle = (i/8) * Math.PI*2;
            ctx.beginPath();
            ctx.arc(Math.cos(angle)*16, Math.sin(angle)*16, 2.5, 0, Math.PI*2);
            ctx.fill();
        }
        ctx.restore(); // çµæŸè¼ªå­æ—‹è½‰
        
        // è¼ªè»¸ä¸­å¿ƒè“‹ (ä¸è½‰)
        ctx.fillStyle = "#222";
        ctx.beginPath();
        ctx.arc(0, 0, 5, 0, Math.PI*2);
        ctx.fill();

        ctx.restore(); // çµæŸèµ·è½æ¶ç¹ªè£½
    }

    function drawScissors(x1, y1, x2, y2) {
        // è¨ˆç®—å‰ªåˆ€è‡‚é—œç¯€
        var armLen = 60; // å–®è‡‚é•·
        var dist = y2 - y1;
        // é™åˆ¶æœ€å¤§è·é›¢ä»¥å…æ–·é–‹
        if(dist > armLen * 2) dist = armLen * 2;
        
        //ç•¢æ°å®šç†æ±‚å¯¬åº¦
        var bulge = Math.sqrt(Math.max(0, armLen*armLen - (dist/2)*(dist/2)));
        
        var midX = x1 - bulge; // é—œç¯€å‘å¾Œå‡¸
        var midY = y1 + dist/2;
        
        ctx.lineWidth = 8;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.strokeStyle = "#666"; // è‡‚èº«é¡è‰²
        
        // ä¸Šè‡‚
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(midX, midY);
        ctx.stroke();
        
        // ä¸‹è‡‚
        ctx.beginPath();
        ctx.moveTo(midX, midY);
        ctx.lineTo(x2, y2);
        ctx.stroke();
        
        // é—œç¯€é»è£é£¾
        ctx.fillStyle = "#333";
        function drawJoint(jx, jy) {
            ctx.beginPath(); ctx.arc(jx, jy, 5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.fillStyle="#888"; ctx.arc(jx, jy, 2, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle="#333";
        }
        drawJoint(x1, y1);
        drawJoint(midX, midY);
        drawJoint(x2, y2);
    }

    function spawnSmoke(count) {
        for(var i=0; i<count; i++) {
            P.smoke.push({
                x: width/2 - 30 + Math.random()*40,
                y: groundY + Math.random()*5,
                vx: -8 - Math.random()*8, // å‘å·¦å™´å°„ (å› ç‚ºå‡è¨­é£›æ©Ÿå‘å³è·‘)
                vy: -2 + Math.random()*4,
                life: 1.0,
                size: 5 + Math.random()*15
            });
        }
    }

    function drawSmoke() {
        for(var i = P.smoke.length-1; i>=0; i--) {
            var p = P.smoke[i];
            p.x += p.vx;
            p.y += p.vy;
            p.vx *= 0.95; // é˜»åŠ›
            p.life -= 0.03;
            p.size += 0.8;
            
            if(p.life <= 0) {
                P.smoke.splice(i, 1);
                continue;
            }
            
            ctx.fillStyle = `rgba(220, 220, 220, ${p.life * 0.4})`;
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
            ctx.fill();
        }
    }

    function showToast(msg) {
        var toast = document.createElement('div');
        toast.innerText = msg;
        toast.style.position = 'absolute';
        toast.style.bottom = '15%';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.background = 'rgba(0,0,0,0.7)';
        toast.style.color = 'white';
        toast.style.padding = '8px 16px';
        toast.style.borderRadius = '20px';
        toast.style.pointerEvents = 'none';
        toast.style.zIndex = '1000';
        toast.style.transition = 'opacity 0.5s';
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 500);
        }, 2000);
    }

    // å‹•ç•«è¿´åœˆ
    function loop() {
        if (!isRunning) return;
        updatePhysics();
        draw();
        window.simAnimationId = requestAnimationFrame(loop);
    }

</script>
</body>
</html>
