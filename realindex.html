<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Soul Mirror | Full Range</title>

<!-- MediaPipe Face Detection & Camera Utils -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/face_detection.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<style>
:root {
  --primary: #00f3ff;
  --secondary: #bc13fe;
  --bg-dark: #000;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Segoe UI", sans-serif;
}

body {
  background: var(--bg-dark);
  overflow: hidden;
}

#input_video {
  display: none;
}

#output_canvas {
  position: fixed;
  inset: 0;
  /* 鏡像翻轉：像照鏡子一樣 */
  transform: scaleX(-1);
}

.status {
  position: fixed;
  bottom: 30px;
  width: 100%;
  text-align: center;
  font-size: 0.9rem;
  letter-spacing: 4px;
  color: rgba(255,255,255,0.4);
  z-index: 10;
}
</style>
</head>

<body>

<video id="input_video" playsinline></video>
<canvas id="output_canvas"></canvas>
<div class="status" id="status">INITIALIZING FULL RANGE SCAN...</div>

<script>
const video = document.getElementById("input_video");
const canvas = document.getElementById("output_canvas");
const ctx = canvas.getContext("2d");
const statusText = document.getElementById("status");

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

let souls = {};

function lerp(a, b, t) {
  return a + (b - a) * t;
}

function drawSoul(x, y) {
  ctx.globalCompositeOperation = "screen";

  const g = ctx.createRadialGradient(x, y, 10, x, y, 120);
  g.addColorStop(0, "rgba(255,255,255,1)");
  g.addColorStop(0.15, "rgba(0,243,255,0.8)");
  g.addColorStop(0.4, "rgba(188,19,254,0.35)");
  g.addColorStop(1, "rgba(0,0,0,0)");

  ctx.beginPath();
  ctx.fillStyle = g;
  ctx.arc(x, y, 140, 0, Math.PI * 2);
  ctx.fill();

  // 能量環
  ctx.beginPath();
  ctx.strokeStyle = "rgba(0,243,255,0.4)";
  ctx.lineWidth = 2;
  ctx.arc(x, y, 55, 0, Math.PI * 2);
  ctx.stroke();

  // 粒子
  for (let i = 0; i < 3; i++) {
    ctx.fillStyle = Math.random() > 0.5 ? "#00f3ff" : "#fff";
    ctx.beginPath();
    ctx.arc(
      x + (Math.random() - 0.5) * 90,
      y + (Math.random() - 0.5) * 90,
      Math.random() * 2.5,
      0,
      Math.PI * 2
    );
    ctx.fill();
  }

  ctx.globalCompositeOperation = "source-over";
}

// ⭐ 關鍵修正：要用 FaceDetection.FaceDetection
const faceDetection = new FaceDetection.FaceDetection({
  locateFile: (file) =>
    `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${file}`,
});

faceDetection.setOptions({
  model: "full",              // 適合教室、多人、遠距
  minDetectionConfidence: 0.5
});

faceDetection.onResults((results) => {
  // 畫布背景
  ctx.fillStyle = "rgba(0,0,0,0.85)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  if (!results.detections || results.detections.length === 0) {
    statusText.innerText = "SEARCHING PRESENCE...";
    return;
  }

  statusText.innerText = `SOULS DETECTED : ${results.detections.length}`;

  results.detections.forEach((det, i) => {
    // legacy face_detection 有 boundingBox，就用這個
    const b = det.boundingBox;
    const cx = b.xCenter * canvas.width;
    const cy = b.yCenter * canvas.height;

    if (!souls[i]) {
      souls[i] = { x: cx, y: cy };
    }

    // 跟隨速度
    souls[i].x = lerp(souls[i].x, cx, 0.25);
    souls[i].y = lerp(souls[i].y, cy, 0.25);

    drawSoul(souls[i].x, souls[i].y);
  });
});

// 啟動鏡頭
const camera = new Camera(video, {
  onFrame: async () => {
    await faceDetection.send({ image: video });
  },
  width: 1280,
  height: 720
});

// 簡單錯誤處理
(async () => {
  try {
    statusText.innerText = "REQUESTING CAMERA ACCESS...";
    await camera.start();
    statusText.innerText = "FULL RANGE SCAN ONLINE";
  } catch (err) {
    console.error(err);
    statusText.innerText = "CAMERA ERROR / PERMISSION DENIED";
  }
})();
</script>

</body>
</html>
